<!DOCTYPE html>
<head>
<title>EOS</title>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/dygraphs@2.2.1/dist/dygraph.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://unpkg.com/dygraphs@2.2.1/dist/dygraph.min.css" />

<style type="text/css">
    #graph {
      position: absolute;
      left: 10px;
      right: 10px;
      top: 10px;
      bottom: 10px;
    }
/*
    #liste { 
    height: 40px;
    position: fixed; 
    bottom:10%;
    width:100%; 
}
*/
</style>
</head>
<body>
<div id="graph"></div>
<!--
<div id="liste"></div>
-->
<script>

grafdata = [[1]];
labels = ['a'];

g = new Dygraph(document.getElementById("graph"), grafdata, {
    animatedZooms: true,
    connectSeparatedPoints: true, //ingen visuelle hull ved manglende data
    labels: ['a'],
    customBars: true,
    title: 'Temperatur fra Florida, Bergen. Meteorologisk institutt (MET)'
});

g.updateOptions({
'file': grafdata,
labels: labels
}); 

var id = '1h5NVjkJVEd7nCfP2H65_qVaOnB-r3XXiBnb5sQkgw2U';
var gid = '0';
var url = 'https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:json&tq&gid='+gid;
//https://docs.google.com/spreadsheets/d/1h5NVjkJVEd7nCfP2H65_qVaOnB-r3XXiBnb5sQkgw2U/edit#gid=0
fetch(url)
  .then(response => response.text())
  .then(data => myItems(data.substring(47).slice(0, -2))  
  );
function myItems(jsonString){
  var json = JSON.parse(jsonString);
  console.log("json object fra google:");
  console.log(json);

  tmp=[];
  labels = [];
  for (let i = 0; i < json.table.cols.length; i++) {
    tmp.push(json.table.cols[i].label);
  } 
  labels = [tmp[0], tmp[2]];
  console.log("labels henta fra json:");
  console.log(labels);

dato = [];
grafdata = [];
  for (let i = 0; i < json.table.rows.length; i++) { // [ [[0]:timestamp, [1]:value1, [2]value2 ... [N]valueN] , ... ]
    tmp=[];
    for (let j = 0; j < json.table.rows[i].c.length; j++){
      if (json.table.rows[i].c[j] === null) {     //ved manglende data settes alt innholdet til null, sjekker først
        tmp.push(null);
      }
      else {
        tmp.push(json.table.rows[i].c[j].v); // C er en array [0]:timestamp, [1]:value1, [2]value2 ... [N]valueN
      }
      
    }
    for (let k = 1; k < tmp.length; k++) {
      tmp[k] = Number(String(tmp[k]).replace(",","."));
    }
    grafdata.push([ tmp[0], [tmp[3], tmp[2], tmp[1]] ]); // dygraph må ha dataen tid, min, avg, max
    dato = grafdata[i][0].split(".");
    grafdata[i][0] = new Date(dato[2]+'/'+dato[1]+'/'+dato[0]); //snur om på dag og år pga krav fra dygraphs
    //grafdata[i][0] = Date.parse(grafdata[i][0] * 1000); //endrer tid-dataen slik at dygraphs kan bruke den
  }

  console.log("grafdata henta og konvertert fra json:");
  console.log(grafdata);

g.updateOptions({
'file': grafdata,
labels: labels
}); 
  
}



</script>

</body>
</html>